<template>
  <div id="app">


    <div class="header">
      
    </div>

    <p class="text">
        Сіра, приземиста будівля лікарні на краю мікрорайону. Біля неї черга з людей старшого віку. На них час від часу покрикує людина в білому халаті. В повітрі стоїть специфічний запах ліків. Біля цього місця не хочеться затримуватися, квапишся зникнути за рогом. Щось схоже згадують українці, коли чують про медицину. 
      <a href="https://dif.org.ua/article/koruptsiya-u-povsyakdennomu-zhitti-ukraintsiv-za-shcho-daemo-khabari-komu-i-chomu345654">Опитування</a>  показують, що медицина була найбільш корумпованою сферою життя українців. Більшості з нас доводилося або давати гроші лікарю, або “неофіційно” платити за ліки, кращий догляд чи зручнішу палату.
    </p>

    <p class="text">
      Система охорони здоров’я, яка склалася в незалежній Україні, виникла ще за Радянського Союзу. На початку ХХІ століття вона остаточно застаріла. Плани щодо її реформування передавалися від одного уряду до іншого. Всі розуміли, що це необхідно робити, але у жодного уряду не вистачало політичної волі, аби здійснити непопулярную реформу. 
    </p>

    <p class="text">
        У 2014 році Міністерство охорони здоров’я, яке очолював Олександр Квіташвілі, створило  <a href="http://uoz.cn.ua/strategiya.pdf">стратегію</a> реформи системи охорони здоров’я до 2020 року. Пізніше міністерство очолила Уляна Супрун — саме вона стала головним лобістом реформи і зуміла її запустити.
    </p>

    <p class="text">
      Як відбулася реформа? Спочатку МОЗ розділило лікарні залежно від їхньої спеціалізації на три рівні. На першому рівні — лікарні, які займаються профілактикою, діагностують і лікують прості хвороби. Там працюють лікарі загальної практики, тобто, сімейні лікарі і педіатри. Якщо пацієнт в складному стані, або якщо лікар на першому рівні не може визначити хворобу, він передає його спеціалісту. 
    </p>

    <p class="text">
        У лікарнях другого рівня працюють лікарі з конкретною спеціальністю: гастроентерологи, гінекологи, ендокринологи та інші. Вони працюють на складнішому обладнанні і можуть допомогти тоді, коли зусиль звичайного лікаря недостатньо. Нарешті, на третьому рівні — лікарні зі складним і дорогим обладнанням і найбільш кваліфікованими лікарями, часто це хірурги. Вони допомагають людям із найсерйознішими хворобами, з якими не змогли впоратися лікарі на нижчих рівнях. 
    </p>

    <p class="text">
        Для чого лікарні поділили на рівні? Для того, щоб почати платити напряму лікарям за реальні послуги, які вони надали. До початку реформи уряд переказував кошти для медицини місцевим бюджетам. Місцева влада розподіляла ці гроші між лікарнями на свій розсуд. В таких умовах у лікарень не було жодних стимулів розвиватися. Вони отримували гроші залежно від кількості працівників, лікарняних ліжок і жителів у районі. Якщо в одній лікарні за рік провели сто операцій, а в іншій одну — отримували вони однаково.  
    </p>

    <p class="text">
        Медреформа запропонувала інший принцип: лікарня отримує гроші за реальну роботу — операції, аналізи, пацієнтів, яким допомогла. Гроші йдуть до лікарень напряму, і розподіляє їх <a href="https://www.kmu.gov.ua/ua/diyalnist/reformi/rozvitok-lyudskogo-kapitalu/reforma-sistemi-ohoroni-zdorovya">Національна служба здоров’я України</a> (НСЗУ). Служба отримує гроші з державного бюджету і визначає, скільки потрібно платити за ті чи інші послуги. Вона з’явилася на початку 2018 року, а в липні вже почала платити лікарням першого рівня. 
    </p>

    <p class="text">
        За законом, перший рівень медичного обслуговування — безкоштовний. До 2020 року другий і третій рівень фінансуватимуться так само, як до реформи. За цей час НСЗУ повинна проаналізувати, за якими медичними послугами звертаються люди, яке обладнання та спеціалісти потрібні лікарням, і скільки все це коштуватиме. На основі своїх підрахунків служба затвердить тарифи — скільки коштує та чи інші медична процедура. Крім тарифів, НСЗУ визначить, за які процедури платить держава, а за які — самі пацієнти.
    </p>

    <p class="text">
        Вже зараз НСЗУ порахувала тариф для лікарень першого рівня, тобто, для сімейних лікарів — 370 гривень за пацієнта на рік. Лікар підписує декларацію з пацієнтом, і після цього отримує свої гроші, а пацієнт може звертатися до лікаря стільки, скільки йому буде потрібно. Це зручно для обох сторін. Пацієнт отримує особистого порадника в медичних питаннях, який значно краще розуміється на людському здоров’ї, добре знає свого пацієнта, і якому не потрібно платити. Лікар отримує стабільний дохід і роботу. 
    </p>

    <p class="text">
        Лікарям другого та третього рівня платитимуть вже за конкретні послуги, але НСЗУ ще тільки рахує, скільки вони повинні коштувати, і за які з них платитиме держава. Остаточні цифри мають з’явитися у 2020 році. Як рахують? Збирають і аналізують статистику про те, на що хворіють люди, до яких лікарів частіше звертаються, і які медичні процедури їм потрібні. 
    </p>



    <h2 class="text">
      <b>На якому етапі реформи ми зараз?</b>
    </h2>

      <p class="text">В середині 2019 року майже завершився перший етап — реформа сімейних лікарів. За цей час у НСЗУ накопичилися такі дані:</p>
      <ul class="text">
         <li>кількість декларацій, підписаних з лікарями;</li>
         <li>перелік лікарень, які підписали договір із НСЗУ;</li>
         <li>щомісячні виплати лікарням від НСЗУ за надані послуги. </li>
      </ul>

    <p class="text">
        Донедавна користувачі могли побачити ці дані лише у вигляді інтерактивних візуалізацій на сайті служби здоров’я, але не могли завантажити й працювати з ними у себе на комп’ютері. 
    </p>

    <p class="text">
        Тепер вони опубліковані у форматі відкритих даних на єдиному національному порталі. Відкриті дані — це публічна інформація в форматах, які дозволяють її автоматичну обробку. Доступ до цих даних та їх використання — вільні та безоплатні.
    </p>

    <p class="text">
        В Україні відкриті дані на державному рівні почали підтримувати в 2015 році. Тоді Кабінет Міністрів України ухвалив Постанову №835, яка визначила, якими мають бути відкриті дані, встановила 300 обов’язкових до публікації наборів даних і вказала, хто їх публікуватиме й на яких умовах. 
    </p>

    <p class="text">
        Дані про про реформу першого рівня медичного забезпечення стали доступними завдяки співпраці НСЗУ з Державним агентством з питань електронного урядування за підтримки проекту USAID/UK aid “Прозорість та підзвітність у публічному управлінні та послугах/TAPAS”. Завдяки цим даним ми можемо оцінити, як змінилась медицина від початку реформи.
    </p>

    <h2 class="text">
      <b>Що змінилось?</b>
    </h2>

    <p class="text">
      Насамперед ми вирішили порахувати, скільки людей підписали декларації в масштабах країни. Для цього ми розрахували відсоток людей від населення районів і міст України, які підписали декларації у лікарнях на своїй території проживання.  Середній показник тих, хто підписав декларації, становить 70% по країні. Варто врахувати, що люди іноді звертаються до лікарів не в своєму районі, особливо якщо живуть поряд із великими містами. Ви можете вибрати область і досліджувати графік самостійно.
    </p>

  <Scrollama 
      :offset="0.9"
      @step-enter="({ element }) => (currStep.push(element.dataset.stepNo))"
  >
     <HorizontalBarChart 
      v-bind:temp="loadData" 
      v-bind:variable="selectedVariable" 
      class="step"
      :class="{ active: 1 == currStep }"
      data-step-no="1"
      v-bind:to-draw="currStep.includes('1')"
      />

  </Scrollama>

    <p class="text">
        Найменша кількість підписаних декларацій — на півдні країни, в середньому — 65%. Саме на півдні знаходиться половина районів, де декларацію підписали менше 50% населення. 
    </p>

    <p class="text">
       Ми також порахували співвідношення кількості лікарів до населення. У нас була гіпотеза, що в сільських районах може бути менше лікарів на 10 тис. населення, ніж у місті.  Але вона не підтвердилася: в середньому по країні — 5 лікарів на 10 тис. людей, і в жодному регіоні їхнє число суттєво не відхиляється від цього показника.
    </p>

    <p class="text">
        Щодо лікарень, які ми аналізували, то вони теж не однакові. Є три групи лікарень, у яких працюють сімейні лікарі — це комунальні й приватні лікарні та лікарі-підприємці (ФОПи). Найбільше в країні комунальних лікарень, вони утворилися з районних поліклінік. Ці лікарні автономні, вони самі вирішують, кого наймати і на що витрачати гроші, але формально вони належать містам. 
    </p>

    <p class="text">
        Більшість людей звертається по допомогу до комунальних лікарень, їх найбільше й вони мають відділення навіть у невеликих селах. Лише жителі обласних центрів та деяких великих міст можуть звертатися ще й до приватних клінік та лікарів-підприємців (ФОПів). За кількістю приватних клінік, які підписали договір із НСЗУ, на третьому місці після Києва і Дніпра знаходяться Суми.
    </p>

    <p class="text">
        Комунальні лікарні доступні, у них розгалужена мережа, і люди до них звикли — але вони не завжди ефективні. Їм потрібно утримувати приміщення й обладнання, які дісталися їм до реформи. Багато грошей доводиться вкладати в ремонти.  Зарплата ж у таких лікарнях залежить від того, як лікарі домовляться з керівництвом. Натомість лікарі можуть позбутися організаційних клопотів і зосередитися на роботі з пацієнтами.
    </p>

    <p class="text">
        Лікарі-підприємці можуть почати свою справу з нуля. Орендувати приміщення, найняти медсестру чи медбрата — і почати практику. Вони ні від кого не залежать, самі вирішують, як витрачати гроші, які заробили. Лікарі можуть об’єднуватися і створювати один ФОП для того, щоб розділити витрати й бюрократичні клопоти між собою. Приватні лікарні в цьому сенсі працюють так само, як комунальні.
    </p>

    <p class="text">
        Ми проаналізували, скільки пацієнтів підписали декларації з лікарем у приватних клініках — і в комунальних медзакладах. На одного лікаря в приватних клініках припадає в середньому 500 пацієнтів, тоді як у комунальних — більше тисячі. Є два пояснення. Перше: люди частіше звертаються до тих лікарень, до яких звикли ходити до реформи. Друге: в приватних медзакладах лікарі менше залежать від грошей НСЗУ, бо паралельно надають платні послуги. 
    </p>

    <p class="text">
       Ще до початку реформи МОЗ і НСЗУ визначили, скільки пацієнтів повинно бути у лікаря. Для того, щоб повноцінно працювати, сімейному лікарю потрібно підписати 1800 декларацій з пацієнтами. Якщо декларацій менше, у нього буде менше грошей, якщо значно більше — держава за них не платитиме. Для педіатрів це число вдвічі менше — 900 пацієнтів. За роботу з ними лікар щомісяця отримує близько 60 тисяч гривень. Ця сума розрахована так, щоб лікарю після всіх витрат на оренду та додатковий персонал залишилось 30-35 тис. гривень зарплати. Як саме витрачати кошти і чому віддати пріоритет, вирішує сама лікарня — або ж лікар, якщо він веде приватну практику.
    </p>

    <p class="text">
      Ми спробували перевірити, скільки лікарів набрали собі рекомендовану кількість пацієнтів. На першому графіку показано, скільки декларацій підписали лікарі. На ньому видно, що найбільше лікарів мають близько 1000 або 2000 пацієнтів. Це два піки на графіку. На другому графіку ми можемо побачити, скільки держава платить лікарям. Тут є лише один пік в районі 60-70 тисяч гривень. Чому?
    </p>

    <div class="finalBars" >
    <BarChart 
      data-step-no="2"
      v-bind:to-draw="currStep.includes('2')"
      v-bind:temp="payments"
      v-bind:oblast="selectedOblast"
      v-bind:variable="'decl_count'" />
    
    <BarChart 
      data-step-no="yes"
      v-bind:to-draw="currStep.includes('yes')"
      v-bind:temp="payments"
      v-bind:oblast="selectedOblast"
      v-bind:variable="'money_per_month'" />
    </div>



    <p class="text">
      Причина в тому, що уряд по-різному платить за пацієнтів різного віку. <a    href="http://moz.gov.ua/article/reform-plan/skilki-groshej-otrimajut-medzakladi-pervinki-za-obslugovuvannja-pacientiv">Базовий тариф</a> за одного пацієнта — 370 грн/рік. Залежно від віку ця сума змінюється: у 4 рази — для пацієнтів-дітей від 0 до 5 років, у 2 рази — для пацієнтів віком понад 65 років. Тому лікар може мати меншу кількість пацієнтів, але отримувати за них такі самі гроші, як і решта лікарів. Адже старшим пацієнтам і дітям потрібно більше догляду й уваги, а пацієнти середнього віку можуть заходити до свого лікаря лише кілька разів на рік.
    </p>


    <p class="text">
      Причина в тому, що уряд по-різному платить за пацієнтів різного віку. <a    href="http://moz.gov.ua/article/reform-plan/skilki-groshej-otrimajut-medzakladi-pervinki-za-obslugovuvannja-pacientiv">Базовий тариф</a> за одного пацієнта — 370 грн/рік. Залежно від віку ця сума змінюється: у 4 рази — для пацієнтів-дітей від 0 до 5 років, у 2 рази — для пацієнтів віком понад 65 років. Тому лікар може мати меншу кількість пацієнтів, але отримувати за них такі самі гроші, як і решта лікарів. Адже старшим пацієнтам і дітям потрібно більше догляду й уваги, а пацієнти середнього віку можуть заходити до свого лікаря лише кілька разів на рік.
    </p>

    <p class="text">
        Вже зараз більшість із 20 тисяч лікарів отримує понад 50 тисяч гривень щомісяця. Але це не означає, що це їхня зарплата. Як ми вже згадували вище, власне зарплату контролюють лише лікарі з приватною практикою. У всіх інших випадках вона залежить від домовленостей із керівництвом лікарні. Лікарні можуть витратити ці гроші на ремонт або купити нове обладнання — і це означає, що вони менше заплатять своєму персоналу. Тому лікарям вигідно створювати ФОПи й займатися приватною практикою.
    </p>


    <h2 class="text">
      <b>На що витрачають лікарні?</b>
    </h2>

    <p class="text">
        Ми спробувати перевірити своє припущення про те, що реформовані лікарні будуть витрачати більше грошей на розвиток.  Для цього ми завантажили усі закупівлі лікарень першого рівня з 2016 року. На жаль,  ми не знаємо, на що витрачають гроші ФОПи й приватні клініки, оскільки вони не зобов’язані звітувати чи проводити тендери. Але комунальні лікарні проводять закупівлі через Prozorro — державний сервіс, що ділиться відкритими даними з усіма охочими.
    </p>


        <div class="procurements step"
      data-step-no="2"
      :class="{ active: 2 == currStep }"
    >
        <h4><b>Порівняння закупівель лікарень за 2017-2019 роки в різних областях, грн.</b></h4>
        
        <div class="parallelPlotOblast">
          <p><i>Графіка інтерактивна, ви можете обирати область зі списку</i></p>
         <multiselect :hide-selected="true" deselect-label="" placeholder="Виберіть область" select-label="" :allow-empty="false" v-model="selectedOblast" :options="oblast_names"></multiselect>
        </div>
       
      <div class="parallelPlot"> 

<!--       <div class="parallelPlotSelect">
      <p>Виберіть область</p>
      <multiselect v-model="selectedOblast" :options="oblast_names"></multiselect>
      </div> -->
    
      <ParallelPlot
        class='line'
        v-for="(d,i) in selectedProcurement"
        v-bind:key="i"
        :name="d.key"
        :inputData="d.values"
        :svgParameters="{width: '100%',height: '100%'}"
        :selectedOblast="selectedOblast"
      />    
      </div> 

    </div> 



    <p class="text">
      Якщо порівняти перші квартали 2017 і 2019 років, більше почали купувати комп’ютерних систем, медичного обладнання, а також меблів, протипожежних систем, кондиціонерів. До реформи лікарні багато років майже не ремонтували, вони стали незручними й навіть небезпечними для людей, які їх відвідують. Тому лікарні почали частіше платити за ремонти, реконструкцію та будівництво.
    </p>

    <p class="text">
        Але найбільше і найрівномірніше зросли витрати на комп’ютери та електронні системи для лікарень, оскільки це вимога реформи. Міністерство охорони здоров’я вимагає від лікарень перевести в електронну форму більшість процесів: електронні кабінети лікарів, електронні картки  пацієнтів, електронні рецепти та системи направлень. Тому лікарням необхідно закуповувати обладнання й комп’ютерні системи.
    </p>

    <p class="text">
      Таким чином, ми бачимо, що лікарні справді почали більше вкладати грошей у розвиток. Ви можете скористатися таблицею внизу, щоб самостійно перевірити, що купують лікарні. <b>Введіть в поле пошуку назву лікарні або товару, який вас цікавить. У таблиці є 100 найбільших закупівель у кожній категорії. Категорії бувають дуже різними, наприклад, медичне обладнання, послуги з будівництва, меблі, комп’ютерна техніка та інші</b>.
    </p>

  

    <div class="tableAndName">
        <h4><b>Таблиця закупівель</b></h4>
        <Table :fixed="true" :small="true" :cpv="codesCPV" class="tableContainer table-fit" :rows="tableData" />
    </div>


  


  </div>
</template>

<script>
import * as d3 from "d3";
import Multiselect from 'vue-multiselect'
import 'intersection-observer' // for cross-browser support
import Scrollama from 'vue-scrollama'


import HorizontalBarChart from './components/HorizontalBarChart.vue'
import BarChart from './components/BarChart.vue'
import LineChart from './components/LineChart.vue'
import ParallelPlot from './components/ParallelPlot.vue'
import Table from './components/Table.vue'



import data from './assets/rajon_stats.json'
import procurement from './assets/procurement_with_regions.json'
import payments from './assets/payments_to_hospitals.json'
import doctorPayments from './assets/payments_to_doctors.json'
import procuramentPivot from './assets/procurements_pivot_with_regions.json'
import tableData from './assets/table_data.json'
import cpv from './assets/cpv.json'







export default {
  name: 'app',
  data() {
    return {
      variables: ['doctors_to_people_ration', 'decl_count'],
      selectedVariable:'declarations_ratio',
      selectedOblast: 'Чернігівська',
      selectedProcurementTypes: [{'name': 'Ремонти', 'code': 'type:45'}, 
      {'name':'Щось там', 'code':'type:30'},
       {'name':'Будівництво', 'code':'type:44'}],
      loadData: data,
      loadProcurements: procuramentPivot,
      loadProcurementPivot: procuramentPivot,
      payments: doctorPayments,
      tableData: tableData,
      codesCPV: cpv,
      chartWidth: 0,
      currentValue: null,
      itemCount: 25,
      min: 10,
      max: 100,
      currStep: [],
    };
  },
  mounted() {
    console.log('App loaded');
    /* this.fetchData(); */
  },
  methods: {
    onSelect(value) {
      this.currentValue = value;
    },
    addTag(newTag) {
      const tag = {
        name: newTag,
      }

      this.allProcurement.push(tag)
      this.selectedProcurementTypes.push(tag)
    },
    stepEnterHandler ({element, index, direction}) {
      // handle the step-event as required here
      console.log(element, index, direction)
    }
/*     async fetchData() {
      let procurements = await d3.csv("./procurement_with_regions.csv");

      this.loadProcurements = procurements;
    } */
  },
  computed: {
    /* tableData: function(){
      this.tableData
    }, */
    oblast_names: function() {
      return [...new Set(this.loadData.map(d => d.oblast))]
    },
    totalProcurements: function() {
      let total = d3.nest().key(d => d.id_item_short).key(d => d.date_month).rollup(function(leaves) { 
        return leaves.map(d => d.sum).reduce((a, b) => a + b);
       }).entries(this.loadProcurements)
       .map(function(group) {
        return {
          key: group.key,
          values: group.values.map(d => {
              return {
                date_month: d.key,
                sum: d.value
              }
          }),
        }
      })
    

      return { 'key': 'Україна',
        'values': total
       }
    },
    nestedProcurement: function() {
      let nest = d3.nest()
        .key(d => d.id_item_short)
        .key(d => d.oblast)
        .rollup(function(leaves) { 
          return {
            2017: d3.sum(leaves, function(d){ return d[2017] }),
            2019: d3.sum(leaves, function(d){ return d[2019] })
           }; 
        })
        .entries(this.loadProcurementPivot.filter(d => d.oblast != null))

      return nest;
    },
    selectedProcurement: function() {
      let selectedOblast = this.selectedOblast
      let selectedProcurementTypes = this.selectedProcurementTypes
      let data = this.nestedProcurement.filter(function(d) {
        return d.values.length > 10
      })

      let selectedData = data.filter(function(d) {
      return ['type:48', 'type:51', 'type:45',
                        'type:35','type:38',
                        /* 'type:70' */, 'type:42',
                        'type:39', 'type:30'].includes(d.key);

      return d.key
      });


      /* let selectedProcurementType = selectedOblastData.values.filter(function(d) {
          return  selectedProcurementTypes.includes(d.key)
      }); */

      return selectedData
    },
    allProcurement: function() {
      return this.nestedProcurement.map((d) => {
          return {'name': d.key};
        })
    }
/*     unnestedProcurements: function() {
      var a = [];
      this.nestedProcurement.map(d => d.values).forEach(d => d.forEach(dd => a.push(dd)))
      return a;
  
    } */
  },
  components: {
    Multiselect,
    LineChart,
    HorizontalBarChart,
    BarChart,
    ParallelPlot,
    Table,
    Scrollama
  },
};
</script>

<style src="vue-multiselect/dist/vue-multiselect.min.css"></style>


<style src="vue-scrollama/dist/vue-scrollama.css">
</style>


<style lang="sass">

* 
  /* border: 1px solid #f00 */
/*   transition: all 3s
 */
body
  margin: 0

div.header
  min-height: 100vh
  background-image: url("./assets/med.gif")
  background-repeat: no-repeat
  background-size: cover
  background-position: center

.text
  margin: 2em 25% 1em 25%
  line-height: 1.5
  font-size: 1.15em
  a
    color: #4555bd
  ul
    margin: 2em 25% 0 25%
    line-height: 1.5
    font-size: 1.15em


div.selectorOblast
  background-color: white
  padding-top: 1em
  padding-bottom: 1em

  h5
    display: flex
    align-items: center
    justify-content: center

path
  stroke-color: white

div.parallelPlotOblast
    display: flex

    p
      margin-left: 3.35em

    div.multiselect
      width: auto
      height: auto
      margin-left: 1em



div.tableAndName  h4
    text-align: center
    padding: 1em
    /* padding-bottom: 16px */

    

div.tableContainer.container-fluid
  padding: 0
  margin: 0
  color: white



  .table
    color: white

div.tableNavigation .row
  color: black
  width: 100%

  legend
    font-weight: bold
    padding-left: 1em
  
  input
    width: auto

  .page-item.active .page-link
    background-color: #4555bd
    border-color: #4555bd
  
  a
    color: black


div.plot
  background-color: #4555bd
  text-aligh: center

  .table
    color: white

div.procurements
  div.parallelPlot
    background-color: #4555bd
    display: grid
    grid-template-columns: 1fr 1fr 1fr 1fr
    padding: 2em 0

  p 
    padding: 0.5em 0em 0.5em 0.5em
  
  h4
    padding: 0.5em 2.7em

#app
  font-family: 'Avenir', Helvetica, Arial, sans-serif
  -webkit-font-smoothing: antialiased
  -moz-osx-font-smoothing: grayscale
  color: #2c3e50
  /* margin-top: 60px */
</style>

<style lang="sass" scoped>
h1, .content
  margin-left: 20px

label
  display: inline-block
  width: 150px

.area-chart
  height: 300px

div.line
  display: inline-block


div.finalBars
  background-color: #4555bd
  display: grid
  grid-template-columns: 1fr
  color: white
  fill: white


rect.bar:hover
  fill: 'red'

.resize-observer
  display: none
  height: 0

table
  text-align: center


.tableNavigation div.navigationRow
    display: flex
    justify-content: center



</style>
