<template>
  <div id="app">

    <div class="header"></div>

    <p
      class="text"
    >Медична реформа — це важлива і водночас складна тема. Легко заплутатись у тому, звідки бере гроші лікарня, на що їх витрачає, скільки пацієнтів зазвичай обслуговує один лікар та як відрізняється прогрес медреформи по регіонах. До того ж, реформа ще не завершилась. У 2019 році закінчується перший етап — реформування первинної ланки, сімейної медицини.</p>

    <p
      class="text"
    >Щоб зрозуміти, які зміни відбулися в медичній сфері за два роки реформи, ми створили серію візуалізацій на основі відкритих даних.</p>
    <h2 class="text">З чого все починалось?</h2>

    <p class="text">
      10 жовтня 2017 Верховна Рада ухвалила закон, який дав старт медичній реформі. Головна його мета — змінити принципи фінансування охорони здоров’я. Відтоді лікарні та лікарі-підприємці отримують гроші за реально надані послуги — операції, аналізи та за пацієнтів, що підписали з ними декларації. Гроші йдуть до лікарень напряму, розподіляє їх
      <a
        href="https://www.kmu.gov.ua/ua/diyalnist/reformi/rozvitok-lyudskogo-kapitalu/reforma-sistemi-ohoroni-zdorovya"
      >Національна служба здоров’я України</a>
      (НСЗУ). Служба отримує гроші з державного бюджету і визначає, скільки потрібно платити за ті чи інші послуги. Вартість послуг пізніше затверджує Кабінет Міністрів.
    </p>

    <p
      class="text"
    >Дані про реформу першого рівня медичного забезпечення стали доступними завдяки співпраці НСЗУ з Державним агентством з питань електронного урядування за підтримки проекту USAID/UK aid “Прозорість та підзвітність у публічному управлінні та послугах/TAPAS”. Завдяки цим даним і візуалізаціям на їхній основі ми можемо оцінити, як змінилась медицина від початку реформи.</p>

    <h2 class="text">Що розповідають дані про реформу?</h2>

    <h3 class="text">
      <b>1. Більшість людей підписали декларацію зі своїм сімейним лікарем</b>
    </h3>

    <p class="text">
      Ми розрахували відсоток людей від населення районів і міст України, які підписали декларації у лікарнях на своїй території проживання. Середній показник тих, хто підписав декларації, становить 70% по країні. Найменша кількість підписаних декларацій — на півдні країни, в середньому — 65%.
      <b>На графіку нижче ви можете вибрати область і досліджувати статистику по регіонах самостійно.</b>
    </p>

    <p
      class="text"
    >Більшість людей звертається по допомогу до комунальних лікарень. Таких закладів найбільше, вони мають відділення навіть у невеликих селах. Але також люди підписують декларації з лікарями-підприємцями і приватними лікарнями. Тож, ми також проаналізували, скільки пацієнтів підписали декларації з лікарем у приватних клініках — і в комунальних медзакладах.</p>

    <p
      class="text"
    >На одного лікаря в приватних клініках припадає в середньому 500 пацієнтів, тоді як у комунальних — більше тисячі. У цього може бути кілька пояснень. Перше: люди частіше звертаються в ті лікарні, в які звикли ходити до реформи. Друге: в приватних медзакладах лікарі менше залежать від грошей НСЗУ, бо паралельно надають платні послуги.</p>

    <h3 class="text">
      <b>2. Навантаження на лікарів збалансоване, і вони можуть отримувати високу зарплату</b>
    </h3>

    <p
      class="text"
    >На початку реформи спеціалісти Національної Служби Здоров’я визначили, скільки пацієнтів повинно бути в одного сімейного лікаря. В середньому це 1800 людей. Якщо їх менше, лікар отримуватиме меншу оплату, якщо більше — держава за цих пацієнтів не платитиме. За роботу з пацієнтами лікар щомісяця отримує близько 60 тисяч гривень. Ця сума розрахована так, щоб лікарю після всіх витрат на оренду та додатковий персонал залишилось 30-35 тис. гривень зарплати. Як саме витрачати кошти і чому віддати пріоритет, вирішує сама лікарня — або ж лікар.</p>

    <p
      class="text"
    >На графіках нижче можна побачити статистику кількості пацієнтів на одного лікаря і виплат на одного лікаря. Якщо лікар працює в лікарні, гроші надходять на її рахунок, а далі вже від головного лікаря залежить, як ними розпоряджатися. Якщо лікар є приватним підприємцем — він сам розпоряджається цими грошима.</p>


    <p
      class="text"
    >Якщо ви досі ще не обрали лікаря для себе та вашої родини. Ви можете зробити це за допомогою нашої візуалізації. Ви можете знайти лікарів, що працюють у вашому місті в таблиці нижче. Та підібрати собі того хто ще не підписав максимум (дві тисячі) декларацій з пацієнтами.</p>

    <h3 class="text">
      <b>3. Лікарні вкладають гроші у свій розвиток</b>
    </h3>

    <p
      class="text"
    >Ми перевірили, що купували медичні заклади до реформи і після неї — і побачили, що лікарні почали купувати більше комп’ютерних систем, медичного обладнання, а також меблів, протипожежних систем і кондиціонерів. Найбільше зросли витрати на комп’ютерні системи.</p>

    <p
      class="text"
    >Національна Служба Здоров’я і Міністерство Охорони Здоров’я вимагають від лікарень перевести в електронну форму всю адміністративну роботу. А отже, їм потрібно купувати обладнання і програми. Завдяки реформі паперові картки й талони відійдуть у минуле. І ми можемо побачити, що цей процес вже почався.</p>


    <p
      class="text"
    >Також ви можете скористатися таблицею внизу, щоб самостійно перевірити, що купують лікарні. Введіть в поле пошуку назву лікарні або товару, який вас цікавить. У таблиці є 100 найбільших закупівель у кожній категорії. Категорії бувають дуже різними — наприклад, медичне обладнання, послуги з будівництва, меблі, комп’ютерна техніка та інші.</p>


    <p class="text">Інструмент розроблено на основі даних НСЗУ, а саме:</p>
    <ul class="text">
      <li>Набір даних про пацієнтів, лікарів та медичні заклади, доступний через відкритий АРІ Національної Служби Здоров’я;</li>
      <li>Дані про тендери медичні закладів з системи публічних закупівель Prozorro.</li>
    </ul>

    <p
      class="text"
    >Дані є відкритими, тобто, це публічна інформація у форматах, які дозволяють її автоматичну обробку та використання. Ви можете отримати доступ до них через відкритий API (посилання коли буде)</p>
  </div>
</template>

<script src="https://gd.geobytes.com/gd?after=-1&variables=GeobytesCountry,GeobytesCity,GeobytesRegion"></script>
<script>
import * as d3 from "d3";
import Multiselect from "vue-multiselect";
/* import "intersection-observer"; // for cross-browser support
import Scrollama from "vue-scrollama";
import jsonp from "jsonp";
import similarity from "similarity"; */

import HorizontalBarChart from "./components/HorizontalBarChart.vue";
import BarChart from "./components/BarChart.vue";
import LineChart from "./components/LineChart.vue";
import ParallelPlot from "./components/ParallelPlot.vue";
import Table from "./components/Table.vue";
import DoctorsTable from "./components/DoctorsTable.vue";

import data from "./assets/rajon_stats.json";
import procurement from "./assets/procurement_with_regions.json";
import payments from "./assets/payments_to_hospitals.json";
import doctorPayments from "./assets/payments_to_doctors.json";
import procuramentPivot from "./assets/procurements_pivot_with_regions.json";
import tableData from "./assets/top_100_per_category.json";
import cpv from "./assets/cpv.json";
import doctorsNames from "./assets/doctors_for_table.json";
import hospitalNames from "./assets/hospital_names.json";

export default {
  name: "app",
  data() {
    return {
      variables: ["doctors_to_people_ration", "decl_count"],
      selectedVariable: "declarations_ratio",
      selectedOblast: "",
      selectedProcurementTypes: [
        { name: "Ремонти", code: "type:45" },
        { name: "Щось там", code: "type:30" },
        { name: "Будівництво", code: "type:44" }
      ],
      loadData: data,
      loadProcurements: procuramentPivot,
      loadProcurementPivot: procuramentPivot,
      payments: doctorPayments,
      tableData: tableData,
      codesCPV: cpv,
      doctorsNames: doctorsNames,
      hospitalNames: hospitalNames,
      chartWidth: 0,
      currentValue: null,
      itemCount: 25,
      min: 10,
      max: 100,
      checker: null,
      currStep: [],
      oblastByIP: "",
      oblastNames: [
        { name: "Misto Kyyiv", data: "Київська" },
        { name: "", data: "Чернігівська" }
      ]
    };
  },
  mounted() {
    /* this.axios.get("http://gd.geobytes.com/GetCityDetails").then((response) => {
      console.log(response)
    }) */

    console.log("trying another way");
    const that = this;

    // jsonp("http://gd.geobytes.com/GetCityDetails?fqcn=", {}, function(err, d) {
    //   that.oblastByIP = d.geobytesregion;
    //   console.log("end of api");
    //   // alert(sGeobytesRegion);

    //   let obl = {
    //     "Misto Kyyiv": "Київ",
    //     "Ternopils'ka Oblast'": "Тернопільска",
    //     "Kirovohrads'ka Oblast'": "Кіровоградська",
    //     "Odes'ka Oblast": "Одеська",
    //     "Poltavs'ka Oblast'": "Полтавська",
    //     "Zhytomyrs'ka Oblast'": "Житомирська",
    //     "Cherkas'ka Oblast": "Черкаська",
    //     "Rivnens'ka Oblast'": "Рівненська",
    //     "Vinnyts'ka Oblast'": "Вінницька",
    //     "Sums'ka Oblast'": "Сумська",
    //     "Khmelnyts'ka Oblast'": "Хмельницька",
    //     "Chernihivs'ka Oblast'": "Чернігівська",
    //     "Dnipropetrovs'ka Oblast'": "Дніпропетровська",
    //     "Chernivetska Oblast'": "Чернівецька",
    //     "Kharkivs'ka Oblast": "Харківська",
    //     "Luhans'ka Oblast'": "Луганська",
    //     "Volyns'ka Oblast'": "Волинська",
    //     "Donets'ka Oblast'": "Донецька",
    //     "Kyivs'ka Oblast'": "Київська",
    //     "Khersonska Oblast'": "Херсонська",
    //     "L'vivs'ka Oblast'": "Львівська",
    //     "Mykolaivska Oblast": "Миколаївська",
    //     "Zaporiz'ka' Oblast": "Запорізька",
    //     "Ivano-Frankivska Oblast'": "Івано-Франківська",
    //     "Zakarpatska Oblast'": "Закарпатська"
    //   };

    //   let obl_names = Object.keys(obl);

    //   let correct_obl =  obl_names.filter((el) => {
    //     return (similarity(el, that.oblastByIP) > 0.8);
    //   });

    //   that.selectedOblast = obl[correct_obl[0]]

    // });

    that.selectedOblast = "Київ";
  },
  methods: {
    onSelect(value) {
      this.currentValue = value;
    },
    addTag(newTag) {
      const tag = {
        name: newTag
      };

      this.allProcurement.push(tag);
      this.selectedProcurementTypes.push(tag);
    },
    stepEnterHandler({ element, index, direction }) {
      // handle the step-event as required here
      console.log(element, index, direction);
    }
    /*     async fetchData() {
      let procurements = await d3.csv("./procurement_with_regions.csv");

      this.loadProcurements = procurements;
    } */
  },
  /*   watch: {
     oblastByIP: function() {
      let obl = {"Misto Kyyiv": "Київ"}
      that.selectedOblast = obl[that.oblastByIP]
    },
  }, */
  computed: {
    /*    set_oblast: function() {
      var oblastByIP = this.oblastByIP
      var val = this.oblastNames.find(function(element) {
            return element.name == oblastByIP;
      })[0];

      return val.data
    }, */
    oblast_names: function() {
      return [...new Set(this.loadData.map(d => d.oblast))];
    },
    totalProcurements: function() {
      let total = d3
        .nest()
        .key(d => d.id_item_short)
        .key(d => d.date_month)
        .rollup(function(leaves) {
          return leaves.map(d => d.sum).reduce((a, b) => a + b);
        })
        .entries(this.loadProcurements)
        .map(function(group) {
          return {
            key: group.key,
            values: group.values.map(d => {
              return {
                date_month: d.key,
                sum: d.value
              };
            })
          };
        });

      return { key: "Україна", values: total };
    },
    nestedProcurement: function() {
      let nest = d3
        .nest()
        .key(d => d.id_item_short)
        .key(d => d.oblast)
        .rollup(function(leaves) {
          return {
            2017: d3.sum(leaves, function(d) {
              return d[2017];
            }),
            2019: d3.sum(leaves, function(d) {
              return d[2019];
            })
          };
        })
        .entries(this.loadProcurementPivot.filter(d => d.oblast != null));

      return nest;
    },
    selectedProcurement: function() {
      let selectedOblast = this.selectedOblast;
      let selectedProcurementTypes = this.selectedProcurementTypes;
      let data = this.nestedProcurement.filter(function(d) {
        return d.values.length > 10;
      });

      let selectedData = data.filter(function(d) {
        return [
          "type:48",
          "type:51",
          "type:45",
          "type:35",
          "type:38",
          ,
          /* 'type:70' */ "type:42",
          "type:39",
          "type:30"
        ].includes(d.key);

        return d.key;
      });

      /* let selectedProcurementType = selectedOblastData.values.filter(function(d) {
          return  selectedProcurementTypes.includes(d.key)
      }); */

      return selectedData;
    },
    allProcurement: function() {
      return this.nestedProcurement.map(d => {
        return { name: d.key };
      });
    }
    /*     unnestedProcurements: function() {
      var a = [];
      this.nestedProcurement.map(d => d.values).forEach(d => d.forEach(dd => a.push(dd)))
      return a;
  
    } */
  },
  components: {
    Multiselect,
    LineChart,
    HorizontalBarChart,
    BarChart,
    ParallelPlot,
    Table,
    /* Scrollama */
    DoctorsTable
  }
};
</script>

<style src="vue-multiselect/dist/vue-multiselect.min.css"></style>



<style lang="sass">

* 
  /* border: 1px solid #f00 */
/*   transition: all 3s
 */
body
  margin: 0

div.header
  min-height: 100vh
  background-image: url("./assets/med.gif")
  background-repeat: no-repeat
  background-size: cover
  background-position: center

.text
  margin: 2em 25% 1em 25%
  line-height: 1.5
  font-size: 1.15em
  a
    color: #4555bd
  ul
    margin: 2em 25% 0 25%
    line-height: 1.5
    font-size: 1.15em

h2.text
  font-size: 2em


.chart
  margin-top: 3em
  margin-bottom: 3em


div.selectorOblast
  background-color: white
  padding-top: 1em
  padding-bottom: 1em

  h5
    display: flex
    align-items: center
    justify-content: center

path
  stroke-color: white

div.parallelPlotOblast
    display: flex

    p
      margin-left: 3.35em

    div.multiselect
      width: auto
      height: auto
      margin-left: 1em



div.tableAndName  h4
    text-align: center
    padding: 1em
    /* padding-bottom: 16px */

    

div.tableContainer.container-fluid
  padding: 0
  margin: 0
  color: white



  .table
    color: white

div.tableNavigation .row
  color: black
  width: 100%

  legend
    font-weight: bold
    padding-left: 1em
  
  input
    width: auto

  .page-item.active .page-link
    background-color: #4555bd
    border-color: #4555bd
  
  a
    color: black


div.plot
  background-color: #4555bd
  text-aligh: center

  .table
    color: white

div.procurements
  div.parallelPlot
    background-color: #4555bd
    display: grid
    grid-template-columns: 1fr 1fr 1fr 1fr
    padding: 2em 0

  p 
    padding: 0.5em 0em 0.5em 0.5em
  
  h4
    padding: 0.5em 2.7em

#app
  font-family: 'Avenir', Helvetica, Arial, sans-serif
  -webkit-font-smoothing: antialiased
  -moz-osx-font-smoothing: grayscale
  color: #2c3e50
  /* margin-top: 60px */
</style>

<style lang="sass" scoped>
h1, .content
  margin-left: 20px

label
  display: inline-block
  width: 150px

.area-chart
  height: 300px

div.line
  display: inline-block


div.finalBars
  background-color: #4555bd
  display: grid
  grid-template-columns: 1fr
  color: white
  fill: white


rect.bar:hover
  fill: 'red'

.resize-observer
  display: none
  height: 0

table
  text-align: center


@media (min-width: 960px)
  table tr th:nth-child(1)
    width: 30%

.tableNavigation div.navigationRow
    display: flex
    justify-content: center



</style>
